<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ImageService ‚Äî –†–µ–∑—É–ª—å—Ç–∞—Ç</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <nav class="navbar">
    <a href="{{ url_for('index.index_page') }}" class="brand">Legacy</a>
    <div class="nav-links">
      <a href="{{ url_for('index.index_page') }}">–ì–ª–∞–≤–Ω–∞—è</a>
      <a href="{{ url_for('search.search_page') }}">–ü–æ–∏—Å–∫</a>
    </div>
  </nav>

  <div class="container">
    <h1>–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è {{ data.original_filename }}</h1>
    <div class="result-card">
      <div class="card">
        <img src="{{ url_for('static', filename='processed/' + data.processed_image) }}"
             alt="–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ {{ data.original_filename }}"
             class="thumbnail">
      </div>
      <div class="download-btn-container">
        <a href="{{ url_for('static', filename='processed/' + data.processed_image) }}"
           class="btn" download>üì• –°–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</a>
      </div>
      {% if data.xml_filename %}
      <div class="download-btn-container" style="margin-top:20px;">
        <a href="{{ url_for('result.download_xml', filename=data.xml_filename) }}"
           class="btn" download>üì• –°–∫–∞—á–∞—Ç—å XML</a>
      </div>
      {% endif %}
      <div class="result-details">
        {% if data.objects_translated %}
          <h3>–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã:</h3>
          <ul>
            {% for obj in data.objects_translated %}
              <li>{{ obj }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <p><em>–ù–µ—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤.</em></p>
        {% endif %}

        {% if data.text %}
          <h3>–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:</h3>
          <pre style="white-space: pre-wrap;">{{ data.text }}</pre>
        {% else %}
          <p><em>–¢–µ–∫—Å—Ç –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω.</em></p>
        {% endif %}

        {% if data.corrected_text %}
          <h3>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:</h3>
          <p>{{ data.corrected_text }}</p>
        {% else %}
          <p><em>–ù–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.</em></p>
        {% endif %}

        {% if data.translated_text %}
          <h3>–ü–µ—Ä–µ–≤–æ–¥:</h3>
          <div id="translationResult">
            <p id="translatedText">{{ data.translated_text }}</p>
            <button id="voicePlayBtn" class="btn">üîä –û–∑–≤—É—á–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥</button>
          </div>
        {% else %}
          <p><em>–ù–µ—Ç –ø–µ—Ä–µ–≤–æ–¥–∞.</em></p>
        {% endif %}
      </div>
    </div>
    <div class="action-buttons">
      <a href="{{ url_for('index.index_page') }}" class="btn">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
    </div>
  </div>

  <div id="imageModal" class="modal">
    <span class="close-btn">&times;</span>
    <img class="modal-content" id="modalImg" alt="–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
    <div id="modalCaption"></div>
  </div>

  <script>
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImg');
    const captionText = document.getElementById('modalCaption');
    const closeBtn = document.querySelector('.close-btn');

    document.querySelectorAll('.thumbnail').forEach(img => {
      img.addEventListener('click', () => {
        modal.style.display = 'block';
        modalImg.src = img.src;
        captionText.textContent = img.alt;
      });
    });

    closeBtn.onclick = () => {
      modal.style.display = 'none';
    };

    document.addEventListener("DOMContentLoaded", () => {
      if (!('speechSynthesis' in window)) {
          alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏.");
          return;
      }

      const translatedTextEl = document.getElementById("translatedText");
      const voiceBtn = document.getElementById("voicePlayBtn");

      if (translatedTextEl && voiceBtn) {
          voiceBtn.addEventListener("click", () => {
              window.speechSynthesis.cancel();
              const text = translatedTextEl.textContent.trim();
              if (text.length > 0) {
                  const utterance = new SpeechSynthesisUtterance(text);
                  utterance.lang = "ru-RU";
                  window.speechSynthesis.speak(utterance);
              } else {
                  console.log("–ù–µ—Ç —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è");
              }
          });
      } else {
          console.log("–≠–ª–µ–º–µ–Ω—Ç—ã –ø–µ—Ä–µ–≤–æ–¥–∞ –∏–ª–∏ –∫–Ω–æ–ø–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
      }
    });
  </script>
</body>
</html>
